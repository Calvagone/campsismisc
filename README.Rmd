---
pagetitle: "CAMPSIS Miscellaneous"
date: ""
author: ""
output: github_document
always_allow_html: true
---

# campsismisc

## Forest plots

Assume the following estimated 2-compartment model:

```{r, message=FALSE}
library(campsismisc)
library(campsisnca)
library(progressr)

model <- read.campsis("tests/testthat/campsis_models/metaboliser_effect_on_cl/")
model
```

This model contains:

- a metabolism effect on the clearance: `THETA_METAB_CL`
- allometric scaling on central and peripheral volumes with a fixed exponent of 1
- a variance-covariance matrix

### Configure your simulation settings

```{r}
# Configure harware
settings <- Settings(Hardware(cpu=8, replicate_parallel=TRUE))
dest <- "mrgsolve" # Much faster than RxODE

# Progress bar
options(progressr.enable=TRUE)
handlers(campsis::campsis_handler())
```


### Effect of metabolism effect and weight on a model parameter

Let's show how the metabolism effect and the weight influence the clearance. This can be achieved as follows:

```{r fp_metabolism_effect_on_cl , fig.align='center', fig.height=4, fig.width=8, message=F}
fp <- ForestPlot(model=model, output=ModelParameterOutput("CL"), replicates=100, dest=dest, settings=settings) %>%
    add(CategoricalLabeledCovariate(name="METAB", default_value=0, label="Metaboliser", categories=c(Slow=0, Fast=1))) %>%
    add(LabeledCovariate(name="WT", default_value=70, label="Weight", unit="kg")) %>%
    add(ForestPlotItem(Covariate("METAB", 0))) %>%
    add(ForestPlotItem(Covariate("METAB", 1))) %>%
    add(ForestPlotItem(Covariate("WT", 60))) %>%
    add(ForestPlotItem(Covariate("WT", 80)))

fp <- with_progress({fp %>% prepare()})
fp %>% getForestPlot +
  ggplot2::scale_y_continuous(breaks=c(0.7,0.8,1,1.25,1.4), limits=c(0.5, 1.5))
```

Now, let's see what happens with the central volume. The configuration is identical.

```{r fp_metabolism_effect_on_vc , fig.align='center', fig.height=4, fig.width=8, message=F}
fp <- ForestPlot(model=model, output=ModelParameterOutput("VC"), replicates=100, dest=dest, settings=settings) %>%
    add(CategoricalLabeledCovariate(name="METAB", default_value=0, label="Metaboliser", categories=c(Slow=0, Fast=1))) %>%
    add(LabeledCovariate(name="WT", default_value=70, label="Weight", unit="kg")) %>%
    add(ForestPlotItem(Covariate("METAB", 0))) %>%
    add(ForestPlotItem(Covariate("METAB", 1))) %>%
    add(ForestPlotItem(Covariate("WT", 60))) %>%
    add(ForestPlotItem(Covariate("WT", 80)))

fp <- with_progress({fp %>% prepare()})
fp %>% getForestPlot +
  ggplot2::scale_y_continuous(breaks=c(0.7,0.8,1,1.25,1.4), limits=c(0.5, 1.5))
```

### Effect of metabolism and weight on a PK metric

Let's show how the metabolism effect and the weight influence AUC. For that, we need to create first a dataset. Assume we are interested to compute AUC on day 1 and day 7. We give the drug every day and we observe on day 1 and day 7.

```{r}
dataset <- Dataset(1) %>%
    add(Infusion(time=0, amount=1000, compartment=1, ii=24, addl=6)) %>%
    add(Observations(times=c(0:24, 144:168)))
```

Instead of creating a `ModelParameterOutput` object, we create a `NcaMetricOutput` and we use any metric from `campsisnca`. To compute AUC on day 1, we need to provide the appropriate filter function.

```{r fp_metabolism_effect_on_auc_d1 , fig.align='center', fig.height=4, fig.width=8, message=F}
fp <- ForestPlot(model=model, dataset=dataset, output=NcaMetricOutput(Auc(variable="CONC"), filter=~timerange(.x, min=0, max=24)),
                 replicates=100, dest=dest, settings=settings) %>%
    add(CategoricalLabeledCovariate(name="METAB", default_value=0, label="Metaboliser", categories=c(Slow=0, Fast=1))) %>%
    add(LabeledCovariate(name="WT", default_value=70, label="Weight", unit="kg")) %>%
    add(ForestPlotItem(Covariate("METAB", 0))) %>%
    add(ForestPlotItem(Covariate("METAB", 1))) %>%
    add(ForestPlotItem(Covariate("WT", 60))) %>%
    add(ForestPlotItem(Covariate("WT", 80)))

fp <- with_progress({fp %>% prepare()})
fp %>% getForestPlot() +
  ggplot2::scale_y_continuous(breaks=c(0.7,0.8,1,1.25,1.4), limits=c(0.5, 1.5))
```

If we are interested to see the absolute change in AUC, argument relative can be set to FALSE as follows.

```{r fp_metabolism_effect_on_auc_d1_absolute , fig.align='center', fig.height=4, fig.width=8, message=F}
fp %>% getForestPlot(relative=FALSE)
```

To look at AUC on day 7, we proceed as follows:

```{r fp_metabolism_effect_on_auc_d7 , fig.align='center', fig.height=4, fig.width=8, message=F}
fp <- ForestPlot(model=model, dataset=dataset,
                       output=NcaMetricOutput(Auc(variable="CONC"), filter=~timerange(.x, min=144, max=168)),
                 replicates=100, dest=dest, settings=settings) %>%
    add(CategoricalLabeledCovariate(name="METAB", default_value=0, label="Metaboliser", categories=c(Slow=0, Fast=1))) %>%
    add(LabeledCovariate(name="WT", default_value=70, label="Weight", unit="kg")) %>%
    add(ForestPlotItem(Covariate("METAB", 0))) %>%
    add(ForestPlotItem(Covariate("METAB", 1))) %>%
    add(ForestPlotItem(Covariate("WT", 60))) %>%
    add(ForestPlotItem(Covariate("WT", 80)))

fp <- with_progress({fp %>% prepare()})
fp %>% getForestPlot() +
  ggplot2::scale_y_continuous(breaks=c(0.7,0.8,1,1.25,1.4), limits=c(0.5, 1.5))
```

Again, we can look at the absolute values.

```{r fp_metabolism_effect_on_auc_d7_absolute , fig.align='center', fig.height=4, fig.width=8, message=F}
fp %>% getForestPlot(relative=FALSE)
```

Let's produce one more plot with Cmax on day 1.

```{r fp_metabolism_effect_on_cmax , fig.align='center', fig.height=4, fig.width=8, message=F}
fp <- ForestPlot(model=model, dataset=dataset,
                       output=NcaMetricOutput(Cmax(variable="CONC"), filter=~timerange(.x, min=0, max=24)),
                 replicates=100, dest=dest, settings=settings) %>%
    add(CategoricalLabeledCovariate(name="METAB", default_value=0, label="Metaboliser", categories=c(Slow=0, Fast=1))) %>%
    add(LabeledCovariate(name="WT", default_value=70, label="Weight", unit="kg")) %>%
    add(ForestPlotItem(Covariate("METAB", 0))) %>%
    add(ForestPlotItem(Covariate("METAB", 1))) %>%
    add(ForestPlotItem(Covariate("WT", 60))) %>%
    add(ForestPlotItem(Covariate("WT", 80)))

fp <- with_progress({fp %>% prepare()})
fp %>% getForestPlot() +
  ggplot2::scale_y_continuous(breaks=c(0.7,0.8,1,1.25,1.4), limits=c(0.5, 1.5))
```

## OAT-method based sensitivity analysis

### Effect of model parameters on a PK metric

Assume the same 2-compartment model. Let's see how the model parameters influence AUC if they are multiplied by two. This can be achieved with a one-at-a-time (OAT)-method-based sensitivity analysis. Most of the time, these analyses are done without parameter uncertainty (replicates=1, by default) and represented with tornado plots, as shown below. However if parameter uncertainty is used, you can still call `getForestPlot()` on this new type of object.

```{r sensibility_analysis_auc_example , fig.align='center', fig.height=3, fig.width=8, message=F}
dataset <- Dataset(1) %>%
  add(Infusion(time=0, amount=1000, compartment=1)) %>%
  add(Observations(times=seq(0, 24, by=0.1))) %>%
  add(Covariate("METAB", 0)) %>%
  add(Covariate("WT", 70))

object <- SensitivityAnalysis(model=model, dataset=dataset,
                     output=NcaMetricOutput(Auc(variable="CONC"))) %>%
  add(SensitivityAnalysisItem(Change("DUR", up=2, down=2))) %>%
  add(SensitivityAnalysisItem(Change("VC", up=2, down=2))) %>%
  add(SensitivityAnalysisItem(Change("VP", up=2, down=2))) %>%
  add(SensitivityAnalysisItem(Change("Q", up=2, down=2))) %>%
  add(SensitivityAnalysisItem(Change("CL", up=2, down=2)))

object <- object %>% prepare()
object %>% getTornadoPlot()
```

Absolute values may also be shown:

```{r sensibility_analysis_auc_example_absolute , fig.align='center', fig.height=3, fig.width=8, message=F}
object %>% getTornadoPlot(relative=FALSE)
```

Let's do the same exercise on Cmax. Let's also show how parameters can be labelled.

```{r sensibility_analysis_cmax_example , fig.align='center', fig.height=3, fig.width=8, message=F}
dataset <- Dataset(1) %>%
  add(Infusion(time=0, amount=1000, compartment=1)) %>%
  add(Observations(times=seq(0, 24, by=0.1))) %>%
  add(Covariate("METAB", 0)) %>%
  add(Covariate("WT", 70))

object <- SensitivityAnalysis(model=model, dataset=dataset,
                     output=NcaMetricOutput(Cmax(variable="CONC"))) %>%
  add(LabeledParameters(c(DUR="Duration", VC="Central volume", VP="Peripheral volume", Q="Inter-compartmental\nclearance", CL="Clearance"))) %>%
  add(SensitivityAnalysisItem(Change("DUR", up=2, down=2))) %>%
  add(SensitivityAnalysisItem(Change("VC", up=2, down=2))) %>%
  add(SensitivityAnalysisItem(Change("VP", up=2, down=2))) %>%
  add(SensitivityAnalysisItem(Change("Q", up=2, down=2))) %>%
  add(SensitivityAnalysisItem(Change("CL", up=10, down=2.5, upDownAsFactor=FALSE))) # Test a clearance of 2.5 and 10

object <- object %>% prepare()
object %>% getTornadoPlot()
```



